---
product:
    videos:
        limit: {{theme_settings.productpage_videos_count}}
    reviews:
        limit: {{theme_settings.productpage_reviews_count}}
    related_products:
        limit: {{theme_settings.productpage_related_products_count}}
    similar_by_views:
        limit: {{theme_settings.productpage_similar_by_views_count}}
products:
    new:
        limit: {{theme_settings.homepage_new_products_count}}
    featured:
        limit: {{theme_settings.homepage_featured_products_count}}
    top_sellers:
        limit: {{theme_settings.homepage_top_products_count}}
gql: "query Experiment($productId: Int!) {
    site {
      product(entityId: $productId) {
        entityId
        variants(first: 50) {
          edges {
            node {
              sku
              inventory{
                isInStock
              }
              defaultImage {
                url(width: 450, height: 450)
              }
              entityId
              productOptions(first: 50) {
                edges {
                  node {
                    ... on MultipleChoiceOption {
                      values {
                        edges {
                          node {
                            entityId
                            label
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
}"  
---
{{inject 'productId' product.id}}

{{#partial "page"}}

    {{> components/common/breadcrumbs breadcrumbs=breadcrumbs}}

    {{#each product.shipping_messages}}
        {{> components/common/alert/alert-info message}}
    {{/each}}
    <div class="container-main-product">
        <div class="col-main-product-container">
            {{> components/products/product-view gql=gql}}
    
            {{{region name="product_below_content"}}}
    
            {{#if product.videos.list.length}}
                {{> components/products/videos product.videos}}
            {{/if}}
    
            {{#all settings.show_product_reviews theme_settings.show_product_reviews (if theme_settings.show_product_details_tabs '!==' true)}}
                {{> components/products/reviews reviews=product.reviews product=product urls=urls}}
            {{/all}}
    
            {{> components/products/tabs}}
        </div>
        <div class="col-main-category-container">
            <ul>
                <li class="main-title-categ">CIGARS</li>
                {{#each categories}}
                    {{#if name '==' 'Cigars'}}
                        {{#each children}}
                            <li class="cigars-children">
                                <a href="{{url}}">{{name}}</a>
                            </li>
                        {{/each}}
                    {{/if}}
                {{/each}}
            </ul>
        </div>
        
    </div>
    
    {{> components/products/schema}}
    <script>
        //on hover product option change main product image request done with 10-12-2024 by j
        document.addEventListener("DOMContentLoaded", function() {
    const gql = document.querySelectorAll('[gql_hover]');
    const mainProductImage = document.querySelector('[data-main-image]');

    let originalAttributes = {}; // Object to store the original attributes

    if (mainProductImage) {
        const mainProductImagePath = mainProductImage.src; // product main image src path
   

        gql.forEach(function(data) {
            const gqlImgPath = data.getAttribute('gql_hover');
            data.addEventListener('mouseover', function() {
      

                // Store the original attributes except for 'src'
                if (mainProductImage) {
                    const attributes = mainProductImage.attributes;
                    Array.from(attributes).forEach(attr => {
                        if (attr.name !== 'src') {
                            originalAttributes[attr.name] = attr.value;
                            mainProductImage.removeAttribute(attr.name);
                        }
                    });

                    // Update the src
                    mainProductImage.src = gqlImgPath;
                }
            });

            // Restore original attributes when mouse leaves
            data.addEventListener('mouseout', function() {
                if (mainProductImage) {
                    // Reapply the original attributes
                    Object.keys(originalAttributes).forEach(attr => {
                        mainProductImage.setAttribute(attr, originalAttributes[attr]);
                    });

                    // Reset the src if needed
                    mainProductImage.src = mainProductImagePath;
                }
            });
        });
    } else {
        console.log('Main product image not found!');
    }
});


    </script>


{{inject "products" product.related_products}}
<script>
function callOptions(){
    var jsContext = JSON.parse({{jsContext}});
    var prod = jsContext.products;
    var entityIds = Object.values(prod).map(p => p.id);
    var idString = entityIds.join(',');
    const query = `
    {
        site {
            products(entityIds: [
                ${idString}
            ], first: 50) {
                edges {
                    cursor
                    node {
                        name
                        inventory {
                            isInStock
                        }
                        entityId
                        showCartAction
                        addToCartUrl
                        availabilityV2 {
                            status
                        }
                        variants {
                            edges {
                                node {
                                    entityId
                                    inventory {
                                        isInStock
                                    }
                                    productOptions(first: 50) {
                                        edges {
                                            node {
                                                entityId
                                                displayName
                                                ... on CheckboxOption {
                                                    checkedByDefault
                                                }
                                                ... on MultipleChoiceOption {
                                                    values(first: 50) {
                                                        edges {
                                                            node {
                                                                entityId
                                                                label
                                                                isDefault
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    sku
                                    prices {
                                        price {
                                            value
                                            currencyCode
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }`;

    fetch('/graphql', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer {{ settings.storefront_api.token }}' 
        },
        body: JSON.stringify({ query })
    })
    .then(res => res.json())
    .then(data => {
        // Sort variant edges for each product
        data.data.site.products.edges.forEach(product => {
            product.node.variants.edges.sort((a, b) => 
                a.node.prices.price.value - b.node.prices.price.value
            );
        });

        var bs = data.data.site.products.edges;
        console.log(bs);

        bs.forEach(function(els) {
            const node = els.node;
            const variants = node.variants?.edges || [];
            const productInStock = node.inventory?.isInStock;
            const anyVariantInStock = variants.some(v => v.node.inventory?.isInStock);
            const hasSingleOption = variants.length > 0 && variants[0].node.productOptions?.edges?.length === 1;

            // Decide whether to show Add to Cart or Notify Me
            const showAddToCart = productInStock && anyVariantInStock;

            // Find product card element
            const liProduct = document.querySelector(`article.card[data-entity-id="${node.entityId}"]`);
            if (!liProduct) return;

            let container = liProduct.querySelector('.container-add-to-cart');
            let formHTML = '';

            if (showAddToCart) {
                // === Add to Cart logic ===
                var labels = node.availabilityV2?.status === "Preorder" ? "Pre Order" : "Add to Cart";
                var extraClass = node.availabilityV2?.status === "Preorder" ? "preorder-btn" : "";

                if (hasSingleOption) {
                    const optionNode = variants[0].node.productOptions.edges[0].node;
                    const optionName = optionNode.displayName;

                    let optionsHTML = '';

                    // Only include in-stock variants
                    variants.forEach(v => {
                        const vNode = v.node;
                        const option = vNode.productOptions?.edges?.[0]?.node;
                        const value = option?.values?.edges?.[0]?.node;

                        if (vNode.inventory?.isInStock && option && value) {
                            optionsHTML += `
                                <div option-price-data=""
                                     option-entityid="attribute[${option.entityId}]"
                                     data-value="${value.label}"
                                     data-option-values="${value.entityId}">
                                    ${value.label}
                                    <span>$${vNode.prices?.price?.value || '0.00'}</span>
                                </div>`;
                        }
                    });

                    formHTML = `
                        <form class="form-custom-option" method="get">
                            <div class="container-custom-options">
                                <div class="dropdown--j">
                                    <div class="dropdown-button--j">
                                        <span class="selected-text--j">Select ${optionName}</span>
                                        <i class="chevron--j"></i>
                                    </div>
                                    <div class="dropdown-menu--j">
                                        ${optionsHTML}
                                    </div>
                                </div>
                                <input type="text" class="hidden-inputs" name="" value="" required>
                                <button class="custom-add-to-cart ${extraClass}" type="submit" cart-urls="${node.addToCartUrl}">
                                    <svg style="width:24px;height:24px;"><use xlink:href="#icon-font-awesome-shopping-cart"></use></svg>
                                    <span class="ac">${labels}</span>
                                </button>
                            </div>
                        </form>`;
                } else {
                    // No options or multiple options
                    formHTML = `
                        <form class="form-custom-option" method="get">
                            <input type="text" class="hidden-inputs" name="" value="${node.entityId}" required>
                            <button class="custom-add-to-cart ${extraClass}" type="submit" cart-urls="${node.addToCartUrl}">
                                <svg style="width:24px;height:24px;"><use xlink:href="#icon-font-awesome-shopping-cart"></use></svg>
                                <span class="ac">${labels}</span>
                            </button>
                        </form>`;
                }
            } else {
                // === Notify Me logic ===
                if (hasSingleOption) {
                    const optionNodeBackInStock = variants[0].node.productOptions.edges[0].node;
                    const optionNameBackInStock = optionNodeBackInStock.displayName;

                    let entityIds = [];
                    let optionLabels = [];
                    let optionPrices = [];

                    variants.forEach(v => {
                        const vNode = v.node;
                        const option = vNode.productOptions?.edges?.[0]?.node;
                        const value = option?.values?.edges?.[0]?.node;

                        if (option && value) {
                            entityIds.push(vNode.entityId);
                            optionLabels.push(value.label);
                            optionPrices.push(vNode.prices?.price?.value?.toFixed(2) || "0.00");
                        }
                    });

                    formHTML = `
                        <div class="container-back-in-stock">
                            <button class="custom-back-in-stock-button" onclick='backInStock(${JSON.stringify(entityIds)}, ${JSON.stringify(optionLabels)}, ${JSON.stringify(optionPrices)})'>
                                <svg style="width:24px;height:24px;"><use xlink:href="#icon-font-awesome-shopping-cart"></use></svg>
                                <span class="ac">Notify Me When Available</span>
                            </button>
                        </div>`;
                } else {
                    // Single variant or no options
                    const firstVariantId = variants[0]?.node.entityId || node.entityId;

                    formHTML = `
                        <div class="container-back-in-stock">
                            <button class="custom-back-in-stock-button" onclick="backInStock([${firstVariantId}])">
                                <svg style="width:24px;height:24px;"><use xlink:href="#icon-font-awesome-shopping-cart"></use></svg>
                                <span class="ac">Notify Me When Available</span>
                            </button>
                        </div>`;
                }
            }

            if (!container) {
                container = document.createElement('div');
                container.className = 'container-add-to-cart';
                container.innerHTML = formHTML;
                liProduct.appendChild(container);
            } else {
                container.innerHTML = formHTML;
            }
        });

        initDropDowns();
    });
}

// === Back in stock modal ===
function backInStock(idArray, option_name, option_price) {
    if (!document.getElementById('back-in-stock-modal')) {
        const modalHTML = `
        <div id="back-in-stock-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;justify-content:center;align-items:center;z-index:9999;">
            <div style="background:#fff;padding:20px;border-radius:8px;max-width:400px;width:90%;position:relative;">
                <h3 style="margin-bottom:10px;" class="naBis">Notify Me When Available</h3>
                <label for="variant-select" class="labelBis">Choose a Variant:</label>
                <select class="inputBis"  id="variant-select" style="width:100%;padding:8px;margin:10px 0;"></select>
                <label for="email-input" class="labelBis">Your Email:</label>
                <input class="inputBis" type="email" id="email-input" placeholder="you@example.com" style="width:100%;padding:8px;margin-bottom:10px;" required>
                <div style="display:flex;justify-content:space-between;">
                    <button class="BisCancel" onclick="document.getElementById('back-in-stock-modal').remove()" style="padding:8px 12px;">Cancel</button>
                    <button class="Bis" onclick="submitBackInStock()" style="padding:8px 12px;">Submit</button>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    const select = document.getElementById('variant-select');
    select.innerHTML = '';

    idArray.forEach(function(id, key) {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = option_name ? `${option_name[key]}: $${option_price[key]}` : id;
        select.appendChild(option);
    });

    document.getElementById('back-in-stock-modal').style.display = 'flex';
}

// === Submit back in stock ===
function submitBackInStock() {
    const variantId = document.getElementById('variant-select').value;
    const email = document.getElementById('email-input').value.trim();

    if (!variantId || !email) {
        alert('Please select a variant and enter a valid email.');
        return;
    }

    const payload = {
        data: {
            type: "back-in-stock-subscription",
            attributes: {
                profile: {
                    data: {
                        type: "profile",
                        attributes: { email }
                    }
                },
                channels: ["EMAIL"]
            },
            relationships: {
                variant: {
                    data: {
                        type: "catalog-variant",
                        id: `$bigcommerce:::$default:::${variantId}`
                    }
                }
            }
        }
    };

    fetch("https://a.klaviyo.com/client/back-in-stock-subscriptions/?company_id=Wqz2D3", {
        method: 'POST',
        headers: {
            "Content-Type": "application/json",
            "revision": "2024-06-15"
        },
        body: JSON.stringify(payload)
    })
    .then(async response => {
        if (response.status === 202) {
            alert("✅ Subscribed successfully!");
            document.getElementById('back-in-stock-modal').remove();
            return;
        }
        const text = await response.text();
        let json = {};
        try { json = JSON.parse(text); } catch { alert("Something went wrong. Please try again."); return; }
        const error = json.errors?.[0];
        if (error) { alert("❌ Error: " + (error.detail || error.title || "Unknown error")); }
        else { alert("❌ Unexpected error. Please try again."); console.error(json); }
    })
    .catch(err => { console.error(err); alert("❌ Network error. Please check your connection."); });
}

// === Dropdown behavior and Add to Cart ===
document.addEventListener('DOMContentLoaded', () => callOptions());

function initDropDowns(){
    document.querySelectorAll('.dropdown-button--j').forEach(button => {
        button.addEventListener('click', function () {
            const dropdown = this.closest('.dropdown--j');
            const menu = dropdown.querySelector('.dropdown-menu--j');
            const chevron = dropdown.querySelector('.chevron--j');
            menu.classList.toggle('show--j');
            chevron.classList.toggle('up--j');
        });
    });

    document.querySelectorAll('.dropdown-menu--j div').forEach(option => {
        option.addEventListener('click', function () {
            const dropdown = this.closest('.dropdown--j');
            const selectedText = dropdown.querySelector('.selected-text--j');
            const menu = dropdown.querySelector('.dropdown-menu--j');
            const chevron = dropdown.querySelector('.chevron--j');
            const parent = dropdown.closest('form');
            const hidden_input = parent.querySelector('input');

            const label = this.getAttribute('data-value');
            const price = this.querySelector('span')?.textContent?.trim() || '';
            selectedText.innerHTML = `${label} <span>${price}</span>`;
            hidden_input.setAttribute('name', this.getAttribute('option-entityid'));
            hidden_input.setAttribute('value', this.getAttribute('data-option-values'));

            menu.classList.remove('show--j');
            chevron.classList.remove('up--j');
        });
    });

    document.querySelectorAll('.custom-add-to-cart').forEach(crt => {
        crt.addEventListener('click', function(e){
            const parent = crt.closest('form');
            const at = parent.querySelector('input');
            const query = at.getAttribute('name') + "=" + at.value;

            if (parent.reportValidity()) {
                crt.querySelector('.ac').textContent = "Adding!";
                crt.style.backgroundColor = "#747474";
                crt.querySelector('.ac').style.color = "white";
                crt.querySelector('svg').style.fill = "white";
                crt.setAttribute('disabled','disabled');
                e.preventDefault();

                const parentUrl = this.getAttribute('cart-urls');
                var cartUrl = parentUrl + "&" + query;
                try { var parsed = new URL(cartUrl); var url = parsed.pathname + parsed.search; } catch {}

                fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.text(); 
                })
                .then(data => {
                    var count = document.querySelector('.countPill.cart-quantity');
                    if (count) {
                        var current = parseInt(count.textContent.trim(), 10) || 0;
                        count.textContent = current + 1;
                        count.classList.add('countPill--positive');

                        crt.querySelector('.ac').textContent = "Added!";
                        setTimeout(() => {
                            crt.querySelector('.ac').textContent = crt.classList.contains('preorder-btn') ? "Pre Order" : "Add to Cart";
                            crt.style.backgroundColor = "black";
                            crt.querySelector('.ac').style.color = "white";
                            crt.querySelector('svg').style.fill = "white";
                            crt.removeAttribute('disabled');
                        }, 2500);
                    }
                })
                .catch(error => console.error('Fetch error:', error));
            }
        });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        document.querySelectorAll('.dropdown--j').forEach(dropdown => {
            if (!dropdown.contains(e.target)) {
                dropdown.querySelector('.dropdown-menu--j').classList.remove('show--j');
                dropdown.querySelector('.chevron--j').classList.remove('up--j');
            }
        });
    });
}
</script>

{{/partial}}
{{> layout/base}}
